// (c)2013 Jorge Colombo - jcolombo@ymail.com - t: @jcolombo_ - f: /Jorge Colombo

(function(window,$,docCookies){function ClientMVC(){var self=this,global={serverPath:'/'+String(window.location.pathname).split('/')[1]},IAM="ClientMVC",IAM_ERROR=IAM+" ERROR: ",VERSION="2.0",ROUTE_ERROR="'hash' ignored!, must be a string without strange characters",LOADER_ROUTE="_LOAD_",ATTR_DATA_PARTIAL="data-partial",ATTR_DATA_ONCHANGE="data-onchange",ATTR_DATA_SECTIONKEY="data-sectionkey",ATTR_DATA_BACKBTN="data-backbtn",ATTR_DATA_LANG="data-lang",APPENDVIEW_SELECTOR=".row,.row-fluid,.container,.container-fluid",LANGUAGE="es",SYMB_LANG="%LANG%",COOKIE_LANG=IAM+"_LANG",timer,started,inHBackFlag,routes=[],othersLoaded,updQueue={},hdeep=0,currentRoute,previousRoute,PARSEPAT=/[\s,]+/g,HTTPMATCH=/https*:/i;if(!($&&window.TExpreso&&$.TExpreso&&docCookies)){console.error(IAM_ERROR,"Missing any dependencies: JQuery 1.5+, TExpreso 1.1+, JQuery TExpreso 1.3+, docCookies");return;};var options={autoStart:true,viewId:"viewId",AG:null,others:null,appPath:"../",sufixURI:"",tplExtension:".html",loadErrorMsg:"<b>... error de carga de página ...</b>",startOnlyOnce:false,onFault:defaultFault,dataAdapter:function(o){return o;}};$.extend(this,{debugLevel:0,LOADER:LOADER_ROUTE,});function defaultFault(ctx,d){var o=ctx||options,text;if(!d)text=o.loadErrorMsg;else if(d.status==401)text='ERROR: '+d.error+'   (Logged: '+d.hLogged+', Location: '+d.hLocation+')';else text='ERROR: '+d.error;alert(text);};function getInputValue(e){return(!String(e.type).match(/(checkbox|radio)/i)?e.value:(e.value.match(/(on|true|false)/i)?(e.checked?true:false):(e.checked?e.value:"")));};function getInputName(e){return e.name;};function _oget(obj,sn){try{var m=obj,ss=sn.split('.');for(var i in ss){m=m[ss[i]];};return m;}catch(x){};return;};function updateModel(route,n,v){var o=_oget(route.model,n);if(o!==undefined){if(o.type=='checkbox')o.checked=v;else o.value=v;options.dataAdapter(o);}};function updateHots(elemName,route){hdeep++;var elems=[],rends=[];$("["+ATTR_DATA_ONCHANGE+"]").each(function(i,e){if(!e.id||rends.indexOf(e.id)<0){rends.push(e.id);var oca=($(e).attr(ATTR_DATA_ONCHANGE)||"").split(PARSEPAT);if(oca.indexOf("*")>-1||oca.indexOf(elemName)>-1){var ctx=$.extend({elemName:elemName},route);if(typeof ctx.onChange=='function'){var sk=$(e).attr(ATTR_DATA_SECTIONKEY);deferred(ctx,ctx.onChange,function(){pushToUpdView((sk?sk:e.id?('#'+e.id):null),elemName);if(hdeep==0)processUdpQueue(ctx);});ctx.proceed(ctx);ctx.resolve();}}}});hdeep--;};function processUdpQueue(route){for(var i in updQueue){if(i.charAt(0)=='#')updQueue[i].elems=$(i).get();else updQueue[i].elems=$("["+ATTR_DATA_SECTIONKEY+"='"+i+"']").get();};var e,chain=[];for(var j in updQueue){var elems=updQueue[j].elems;if(elems.length<1)continue;var cause=updQueue[j].cause;log(".processUdpQueue() caused by: '"+cause+"'");for(var i in elems){e=elems[i];var sk=$(e).attr(ATTR_DATA_SECTIONKEY),tpl=$(e).attr(ATTR_DATA_PARTIAL);var obj=sk?_oget(route.model,sk):route.model;$(e).TExpreso(tpl,obj);$(e).find("input,select").not(":button,:reset,:submit").change(function(){return inputCallback(this,route);});$(e).find("button,a,input[type='button']").not(":submit").click(function(){return inputCallback(this,route);});$(e).find("form").submit(function(){return inputCallback(this,route);});$(e).find("["+ATTR_DATA_BACKBTN+"]").click(function(){return backBtnCallback(this);});log("\tre-render sectionkey or #id '"+(sk?sk:'#'+e.id)+"' with partial-template: '"+tpl+"'");sk?chain.push(sk):e.id?chain.push('#'+e.id):null;}};updQueue={};for(var i in chain){updateHots(chain[i],route);}};function inputCallback(elem,route){var rv=false,alink,ctx=$.extend({elem:elem},route);var tagType=String(elem.tagName==='FORM'?'submit':elem.tagName==='A'?'a':elem.type).toLowerCase();if(tagType.match(/^(a|button|submit)$/i)){rv=true;if(tagType==='submit'){if(!$(elem).attr("action")&&elem.name)$(elem).attr("action",elem.name);alink=$(elem).attr("action");$.extend(ctx,{data:getFORMData(elem),actionLink:alink,type:'submit'});}else if(tagType==='a'){alink=$(elem).attr("href");var alp=parseHRef(alink);alink=alp.hash;$.extend(ctx,{actionLink:alink,a:alp,type:'a'});}else{alink=elem.name||elem.value||elem.id;$.extend(ctx,{actionLink:alink,type:'button'});};log(".onClick() callback: '"+tagType+"', actionLink: '"+alink+"', type: '"+ctx.type+"', value: '"+getInputValue(elem)+"' "+(ctx.data?"**FORM DATA**":"")+" (hash: "+route.hash+")");if(self.debugLevel>1&&ctx.data)logd("** DATA FORM for actionLink: '"+alink+"' (in ctx.data) **",ctx.data);if(self.debugLevel>2&&route.model)logd('** ROUTE "'+route.hash+'" DATA MODEL (in route.model) **',route.model);if(typeof ctx.onClick=='function'){deferred(ctx,ctx.onClick,function(){processUdpQueue(ctx);checkToGo(ctx);});if((rv=ctx.proceed(ctx))===undefined){rv=(tagType==='submit')||(tagType==='a'&&alink.indexOf('#_')==0)?false:true;};ctx.resolve();};if(tagType==='a'){var dlang=$(elem).attr(ATTR_DATA_LANG);if(dlang){self.setLanguage(dlang);return false;};};return rv;};updateModel(route,getInputName(elem),getInputValue(elem));updateHots(elem.name,route);log('Was callback CHANGE elem name: \''+getInputName(elem)+'\', value: "'+getInputValue(elem)+'" (hash: '+route.hash+')');return true;};function backBtnCallback(e){currentRoute.thenGo=currentRoute.backBtn||$(e).attr(ATTR_DATA_BACKBTN)||'.back';checkToGo(currentRoute);return true;};function parseHRef(href){var rv={path:'',query:'',hash:''};if(!href)return rv;var p,h=href.indexOf('#'),q=href.indexOf('?');if(h>=0&&q>=0&&h>q){p=href.split(/[?#]/);rv={path:p.shift(),query:p.shift(),hash:'#'+p.shift()};}else if(h>=0&&q>=0&&h<q){p=href.split(/[?#]/);rv={path:p.shift(),hash:'#'+p.shift(),query:p.shift()};}else if(h>=0&&q<0){p=href.split('#');rv={path:p.shift(),query:'',hash:'#'+p.shift()};}else if(h<0&&q>=0){p=href.split('?');rv={path:p.shift(),query:p.shift(),hash:''};}else if(href){rv={path:href,query:'',hash:''};};return rv;};function checkToGo(ctx){if(typeof ctx.thenGo!=='string')return;var f;if(ctx.thenGo.match(/\.back/i)){f=function(){window.history.back();};}else if(ctx.thenGo.match(/\.refresh/i)){f=function(){renderRoute(currentRoute,true);};}else{var new_url;if(ctx.thenGo.match(HTTPMATCH))new_url=ctx.thenGo;else if(ctx.thenGo=='/')new_url='../../';else if(ctx.thenGo.indexOf('/')>=0)new_url=window.location.protocol+'//'+window.location.host+ctx.thenGo;else new_url=ctx.thenGo?"#"+ctx.thenGo:"#";if(ctx.noHistory)f=function(){window.location.replace(new_url);};else f=function(){window.location.assign(new_url);};};ctx.thenGo=null;setTimeout(f,100);};function getFORMData(form){var radios=[],data={};var assign=function(n,v){try{data[(n)]=v;}catch(x){};};$(form).find("input,select").not(":button,:reset,:submit").each(function(i,e){if(!e.name)return;if(String(e.type).match(/radio/i)){if(radios.indexOf(e.name)<0)radios.push(e.name);}else{assign(e.name,getInputValue(e));}});if(radios.length==0)return data;while(radios.length>0){var n=radios.shift(),rv='';$(form).find(":radio[name='"+n+"']").each(function(i,e){if(e.checked){rv=e.value;return false;}});assign(n,rv);};return data;};function renderRoute(route,refreshing){if(!route)return;var jid='#'+options.viewId;var doit=function(rou){$(jid).TExpreso(rou.template,rou.model);if(!refreshing){previousRoute=currentRoute;currentRoute=rou;};rou.displayed=true;$(jid).find("input,select").not(":button,:reset,:submit").change(function(){return inputCallback(this,rou);});$(jid).find("button,a,input[type='button']").not(":submit").click(function(){return inputCallback(this,rou);});$(jid).find("form").submit(function(){return inputCallback(this,rou);});$(jid).find("["+ATTR_DATA_BACKBTN+"]").click(function(){return backBtnCallback(this);});var thenFn;if(rou.hash!==LOADER_ROUTE){thenFn=function(){processUdpQueue(rou);checkToGo(rou);};}else{thenFn=function(){processUdpQueue(rou);hashChange({starting:true,oldURL:null,newURL:window.location.href});};};log('.renderRoute(): '+routeLog(rou));if(typeof rou.started=='function'){deferred(rou,rou.started,thenFn);rou.proceed();rou.resolve();log('.started() called for hash: '+routeLog(rou));}};loadTemplates(route,doit,function(){$(jid).html(options.loadErrorMsg);currentRoute=null;});};function loadTemplates(route,done,fail){var queue=[];var repSymb=function(f){return f.replace('%LANG%',LANGUAGE);};var wdir=function(f,far){return(far?options.appPath+f+options.tplExtension:route.appPath+route.sufixURI+"/"+f+route.tplExtension);};var toLoad=function(f,far){if(f){if(f instanceof Array){for(var i in f){var url=wdir(repSymb(f[i]),far);if(!$.TExpreso.has(f[i])&&!$.TExpreso.hasUrl(url))queue.push(url);}}else{var url=wdir(repSymb(f),far);var xxx=$.TExpreso.has(f);if(!$.TExpreso.has(f)&&!$.TExpreso.hasUrl(url))queue.push(url);}}};toLoad(route.template);toLoad(route.templates);if(!othersLoaded){othersLoaded=true;toLoad(options.others,true);};if(queue.length==0){done(route);return;};var ctx={count:0,hash:route.hash,load:function(cx,q){cx.defer(q.length);for(var i in q){var qq=q[i];$.TExpreso.addFromUrl(q[i],function(cnt,tt){if(cnt!=0){log("<< Remote template loaded: "+tt);cx.count++;}else{console.warn(IAM_ERROR,'!! Template NOT found! (path: '+tt+')');};cx.ready(cx.count);});}}};deferred(ctx,ctx.load,function(count){if(count==queue.length)done(route);else fail();});ctx.proceed(queue);ctx.resolve();};function conventionsAdapter(tplName,content){if(!content)return'';var tag,p2,dones=0,logx=".conventionsAdapter to tpl '"+tplName+"'";var _attrs=function(str,attr){var rv=[],patt=new RegExp(attr+'\\s*=\\s*["\']',"ig"),patt2=/["']/,patt3=/>/,lix,clo,end,tag;while(patt.test(str)==true){var xx=str.slice(patt.lastIndex);if((lix=xx.search(patt2))<0)continue;var at=xx.substring(0,lix).trim();if(at){clo=(clo=xx.search(patt3))>0?clo:0;if(clo>0&&xx.charAt(clo-1)!=='/'){var patt4=new RegExp('</[a-z]+\\s*>','gi');if((tag=(tag=(tag=patt4.exec(xx))?tag[0]:'')?tag.substring(2,tag.length-1):'')){end=patt4.lastIndex-tag.length-3;rv.push({attr:at,close:clo+patt.lastIndex,tag:tag,endtag:end+patt.lastIndex,inner:xx.substring(clo+1,end)});}}}};return rv;};var _adapt=function(str,attr,fnWrite){var dp=_attrs(str,attr);var txt='',p=0;for(var i in dp){txt=txt+str.substring(p,dp[i].close+1)+fnWrite(dp[i]);p=dp[i].endtag;};return(txt+str.slice(p));};if(!(tag=content.match(/<[a-z]+[\s>]/i))){console.warn(IAM,logx+" ***!! POSSIBLE MALFORMED HTML !!***");return content;};content=_adapt(content,ATTR_DATA_PARTIAL,function(d){return"{{> "+d.attr+"}}";});content=_adapt(content,ATTR_DATA_SECTIONKEY,function(d){return"{{#"+d.attr+"}}"+d.inner+"{{/"+d.attr+"}}";});return content;};function hashChange(e){if(inHBackFlag){inHBackFlag=false;return false;};if(/#$/.test(e.newURL)){reject();return false;};var h=window.location.hash.length>0?window.location.hash.slice(1):'';var route;if(!(route=takeRoute(h,window.location.search))){if(String(window.location.href).match(window.location.pathname)){if(h.charAt(0)!=='_')reject("Hash '"+h+"' NOT found, maybe should create it with whenRoute()?",true);}else if(window.location.pathname!=window.location.href){window.location.replace(window.location.pathname);}else{console.warn("Should create at least one route with whenRoute()");};return false;};var cur_hash=currentRoute?currentRoute.hash:null;var mustStart=!route.startOnlyOnce||!route.displayed;if(mustStart&&route.previousHashReq&&route.previousHashReq!==cur_hash){window.location.replace(window.location.pathname+'#'+route.previousHashReq);return false;};var hBack=cur_hash&&(route.autoBack instanceof Array)&&route.autoBack.indexOf(cur_hash)>=0?true:false;if(window.history.length>1&&((route.displayed&&route.autoBack===true)||hBack)){reject("hashChange to '"+h+"' was autoBack'ed...");return false;};log('hashChange - [ '+e.oldURL+' ] >> [ '+e.newURL+' ]');if(mustStart){try{if(typeof route.modelCopyFrom==='function')route.model=route.modelCopyFrom(route,routes);if(typeof route.modelCopyFrom==='string')route.model=$.extend({},getRoute(route.modelCopyFrom).model);if(typeof route.modelCopyFrom==='object')route.model=route.modelCopyFrom;}catch(e){console.error(IAM_ERROR,"Posible Error: Can´t copy model from route '"+route.modelCopyFrom+"'... it don't exists!");};if(typeof route.start=='function'){startRoute(route,reject);return true;}};renderRoute(route);return true;};function reject(msg,isWarn){inHBackFlag=true;if(window.history.length>1)window.history.back();else window.location.replace(window.location.pathname);if(msg)isWarn?console.warn(IAM,"REJECTED 'hashChange'. "+msg):console.info("REJECTED 'hashChange'. "+msg);};function startRoute(route){deferred(route,route.start,function(){renderRoute(route);},function(){reject(null,"rejected by js");});route.proceed();route.resolve();log('.start() called for hash: '+routeLog(route));};function deferred(context,fnproceed,fndone,fnreject){var em=' mal invocado! - context: '+context.hash,d={_stat:{used:0,code:-1},proceed:function(data){if(context._stat.code!=-1)console.error('deferred.proceed()'+em);else{context._stat.code=0;return fnproceed(context,data);}},resolve:function(){if(context._stat.code==0&&context._stat.used<=0)context.ready();},defer:function(n){if(context._stat.code!=0)console.error('deferred.defer()'+em);else context._stat.used+=(n?n:1);},ready:function(data){if(context._stat.code<0)console.error('deferred.ready()'+em);else if(context._stat.code==0&&--context._stat.used<=0){context._stat.code=1;if(typeof fndone==='function')fndone(data);}},reject:function(data){if(context._stat.code==0){context._stat.code=1;if(typeof fnreject==='function')fnreject(data);}},};return $.extend(context,d);};function routeLog(r){var pars=r.params?$.param(r.params).replace(/&/gi,', '):null;return'"'+r.hash+'" - params: '+(pars?pars:'(no)');};function getRoute(hash){var route;if(!hash&&routes.length>0){for(var i in routes){if(routes[i].hash!=LOADER_ROUTE){route=routes[i];break;}};}else{for(var i in routes){if(routes[i].hash==hash){route=routes[i];break;}};};return route;};function takeRoute(hashStr,query){var route,arr,hash;arr=hashStr.split('/');var hash=arr.shift();if(!(route=getRoute(hash)))return null;route.params={};if(route.paramNames){for(var i in route.paramNames){route.params[route.paramNames[i]]=arr.shift();}};route.query=String(query||'').charAt(0)=='?'?query.slice(1):(query||'');return route;};function createRoute(hashStr,ops){if(typeof hashStr!='string'||hashStr.trim().length==0){console.error(IAM_ERROR,ROUTE_ERROR);return null;};var arr=hashStr.split('/@');for(var i in arr){if(!arr[i].match(/^[a-z0-9_-]+$/i)){console.error(IAM_ERROR,ROUTE_ERROR+' -- hash string: "'+hashStr+'"');return null;}};var hash=arr.shift();var route={model:{global:global},hash:hash,template:hash,paramNames:(arr.length>0?arr:null),params:null,displayed:false,autoBack:false};$.extend(route,{appPath:options.appPath,sufixURI:options.sufixURI,tplExtension:options.tplExtension,loadErrorMsg:options.loadErrorMsg,startOnlyOnce:options.startOnlyOnce,},ops,route_methods);return route;};function setModelView(data,ns,ovw){if(!data)return this;var nsh=ns?ns+'.':'';for(var i in data){options.dataAdapter(data[i],nsh+i)};if(ovw===undefined||ovw==false){if(ns){if(this.model[ns]===undefined)this.model[ns]={};$.extend(this.model[ns],data);}else $.extend(this.model,data);}else{if(ns)this.model[ns]=data;else this.model=data;};return this;};function clearModel(){this.model={global:global};return this;};function getModelValue(names,ns,innerNs){names=typeof names==='string'?names.trim().split(PARSEPAT):names;if(typeof ns==='boolean'){innerNs=ns;ns='';}else ns=ns?ns+'.':'';var rv={},route=this;for(var i in names){var o=_oget(route.model,ns+names[i]);if(o){if(!o.type&&typeof o==='object'){var nss='';for(var j in o){nss=nss+j+' ';};$.extend(rv,route.getv(nss,ns+names[i],innerNs));}else{o=o.type===undefined?o:o.type=='checkbox'?o.checked:o.value;var n=ns+names[i];rv[(innerNs?n.slice(n.indexOf('.')+1):n)]=o==undefined?'':o;}}};return rv;};function setModelValue(obj){for(var i in obj){updateModel(this,i,obj[i]);pushToUpdView(i,'js (setv)');};return this;};function pushToUpdView(ref,cause){if((ref=(ref||"").trim())&&!updQueue[ref])updQueue[ref]={cause:(cause?cause:'code')};return this;};function onHelper(elemName,args){var ctx=this,en,qs='',rv;if(typeof elemName==='string')en=ctx.actionLink?ctx.actionLink:ctx.elemName?ctx.elemName:'*?*';else if(typeof elemName==='object'&&args===undefined)args=elemName;if(en){qs=en.split('/');en=qs.shift();qs=qs.length>0?'/'+qs.join('/'):'';};if(!en||en==elemName){log('on "'+elemName+'" correspondido!');var df=args.data||ctx.data;if(typeof df==='string')df=ctx.getv(df);var sdata=$.extend({},{data:df});var exec=function(f,d){return(typeof f==='function')?f(d,ctx):null;};var cbkfn=function(d){if(d.success){if(exec(args.success,d)===false)return;if(args.into)ctx.setModelView(d.result,args.into);else if(args.into!==false)ctx.setModelView(d.result);if(exec(args.complete,d)===false)return;}else{var efn=args.onFault||ctx.onFault||options.onFault;if(typeof efn==='function'){efn(ctx,d);return;}};if(exec(args.allways,d)===false)return;if(!ctx.thenGo){if(typeof args.thenGo==='string')ctx.thenGo=args.thenGo;else ctx.thenGo=exec(args.thenGo,d);};if(args.display)ctx.display(args.display);return d.success?true:false;};var shell=function(d){if(cbkfn(d))ctx.ready();else ctx.reject();};var ag=args.AG||ctx.AG||options.AG;if(ag){ctx.defer();ag.setLanguage(LANGUAGE);qs=args.q?qs+'?'+args.q:qs;if(args.get)ag.get(args.get+qs,shell,sdata);else if(args.post)ag.post(args.post+qs,shell,sdata);}else{console.error(IAM_ERROR,"Must supply AjaxGrails provider in .on() / .make()");};rv=true;};return rv;};function setDisplayed(v){this.getRoute(this.hash).displayed=v?true:false;};function goHelper(url){this.thenGo=!url?'':url;};function display(idsOrSks){idsOrSks=typeof idsOrSks==='string'?idsOrSks.split(PARSEPAT):idsOrSks;for(var i in idsOrSks){if(idsOrSks[i])pushToUpdView(idsOrSks[i]);};};var route_methods={getRoute:getRoute,clear:clearModel,setModelView:setModelView,getv:getModelValue,setv:setModelValue,display:display,on:onHelper,make:onHelper,setDisplayed:setDisplayed,go:goHelper,adapt:options.dataAdapter,};this.whenRoute=function(hash,ops){var route;if(!(route=createRoute(hash,ops)))return{};routes.push(route);return route;};this.whenLoader=function(ops){return self.whenRoute(LOADER_ROUTE,ops);};this.setLanguage=function(lang,reload){if(lang&&lang!=LANGUAGE){docCookies.setItem(COOKIE_LANG,lang,Infinity,(/\/[a-z0-9-_\$\.;,%]+/i.exec(location.pathname)));if(options.AG)options.AG.setLanguage(lang);if(reload||reload===undefined)window.location.reload();else LANGUAGE=lang;}};this.getLanguage=function(){return LANGUAGE;};this.start=function(opts){if(started)return;started=true;$.extend(options,opts);$('document').ready(function(){LANGUAGE=(docCookies.getItem(COOKIE_LANG)||window.navigator.language||window.navigator.userLanguage||window.navigator.browserLanguage).substring(0,2);if(options.AG)options.AG.setLanguage(LANGUAGE);log('## Start ClientMVC v'+VERSION+' ## - LANGUAGE: "'+LANGUAGE+'" ##');if(options.viewId&&document.getElementById(options.viewId)==null){$(APPENDVIEW_SELECTOR+' :first').prepend('<div id="'+options.viewId+'">');if(document.getElementById(options.viewId)==null)console.error(IAM_ERROR,"Could not find the element w/ id='"+options.viewId+"' or classes "+APPENDVIEW_SELECTOR+" (required for stamp templates)!");return;};if(routes.length<1){console.error(IAM_ERROR,"No route was defined !");return;};if(window.dataAdapter)options.dataAdapter=window.dataAdapter;else log('Warning! No data adapter was defined ! (should load dataAdapter.js)');$.TExpreso.setAddInterceptor(conventionsAdapter);$.TExpreso.addFromDom();window.onhashchange=hashChange;var loader=getRoute(LOADER_ROUTE);if(loader){if(typeof loader.start=='function')startRoute(loader);else renderRoute(loader);}else{hashChange({starting:true,oldURL:null,newURL:window.location.href});};$("["+ATTR_DATA_BACKBTN+"]").click(function(){return backBtnCallback(this);});});};this.log=function(c,d){logd((c!=undefined?c:currentRoute),d);};function log(t1,t2){if(self.debugLevel<1)return;if(!self.debugLogId){if(t2)console.info(t1,t2);else console.info(t1);}else{$('#'+self.debugLogId).append(t1+' '+(t2?t2:'')+'<br>')};};function logd(c,d,t){t=t?t:'\t';if(d==undefined)d=c;else if(c)log(c);for(var n in d){if(typeof d[n]=='function')continue;if(n.substring(0,2)=='_$'&&self.debugLevel<4)continue;log(t+n+' = '+d[n]);if(typeof d[n]=='object')logd('',d[n],t+'\t');}};};if(!window.ClientMVC){window.ClientMVC=new ClientMVC();window.MVC=window.ClientMVC;};}(window,jQuery,docCookies));(function(window){if("onhashchange"in window.document.body){return;};var location=window.location,oldURL=location.href,oldHash=location.hash;setInterval(function(){var newURL=location.href,newHash=location.hash;if(newHash!=oldHash&&typeof window.onhashchange==="function"){window.onhashchange({type:"hashchange",oldURL:oldURL,newURL:newURL});oldURL=newURL;oldHash=newHash;}},100);})(window);